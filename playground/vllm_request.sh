#!/bin/bash

# Fixed vLLM request script

curl -X POST "http://localhost:8000/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer token-abc123" \
  -d '{
    "model": "yigitturali/qwen3-0.6b-qa-decomp-gsw-rank-128-gpt5-golden",
    "messages": [
      {
        "role": "user",
        "content": "Your task is to break down a complex multi-hop question into the most efficient sequence of single-hop, **atomic** questions.\n\n## Your Main Goal: Build Smart Bridges, Don'\''t Just Collect Nouns\nThe most critical skill is to convert complex logical clauses (like \"despite,\" \"the country where,\" \"the year before\") into a single, powerful **bridging question**. This question should use a known entity as context to find the next one. Avoid finding all the entities separately and then trying to figure out how they connect.\n\n---\n## A Simple Analogy for Efficiency\n\n**Question:** \"What is the phone number of the mother of the tallest player on the Lakers?\"\n\n** Inefficient Path:**\n1.  Who are the players on the Lakers?\n2.  What are all their heights?\n3.  Who is the mother of the tallest player? *(This step is a logical leap)*\n\n** Efficient Path:**\n1.  Who is the tallest player on the Lakers?\n2.  Who is the mother of `<ENTITY_Q1>`?\n3.  What is the phone number of `<ENTITY_Q2>`?\n\n---\n## How to Decompose a Question\nThis process follows a logical flow from high-level analysis to the fine-tuning of your question chain.\n\n### 1. Analyze the Query'\''s Components\nFirst, break down the original question into its fundamental building blocks. Identify the core **entities** (people, places, organizations), their **properties** (attributes like rank, location, date), and the **relationships** that connect them.\n\n### 2. Construct an Atomic Chain\nNext, formulate a sequence of questions where each question retrieves a single fact.\n* **Isolate Comparisons:** Don'\''t ask \"who is faster?\" Ask for the specific rank or time of each person involved.\n* **Link with Placeholders:** Use `<ENTITY_Qn>` to pass the answer from a previous question (`Qn`) into the next one.\n\n### 3. Optimize for Efficiency and Precision\nYour final goal is the **shortest and most direct path** to the answer.\n* **Embed Constraints to Build Bridges:** If a piece of information is only a filter (like a date or location), embed it as a constraint in the next question instead of asking for it directly.\n  **Important note for bridges:** There can be no `<ENTITY_Qn>` in the first question if the nth question DOES NOT require retrieval.\n\n## Formatting\nFormat each decomposed question as follows:\n\n<decomposition>\nQuestion: [the question text]\nRequires retrieval: [true/false]\n\nAnd provide the response in the following json format:\n{\n  \"questions\": [\n    {\n      \"question\": \"the decomposed question text\",\n      \"requires_retrieval\": \"true/false\"\n    }\n  ]\n}\n\nExamples:\n\nInput: \"What is the birth year of the spouse of the director of Casablanca?\"\nOutput:\n{\n    \"questions\": [\n        {\n            \"question\": \"Who directed Casablanca?\",\n            \"requires_retrieval\": \"true\"\n        },\n        {\n            \"question\": \"Who was <ENTITY_Q1>'\''s spouse?\",\n            \"requires_retrieval\": \"true\"\n        },\n        {\n            \"question\": \"What is <ENTITY_Q2>'\''s birth year?\",\n            \"requires_retrieval\": \"true\"\n        }\n    ]\n}\n\nInput: \"Which film has the director who is older, Dune or The Dark Knight?\"\nOutput:\n{\n    \"questions\": [\n        {\n            \"question\": \"Who directed Dune?\",\n            \"requires_retrieval\": \"true\"\n        },\n        {\n            \"question\": \"Who directed The Dark Knight?\",\n            \"requires_retrieval\": \"true\"\n        },\n        {\n            \"question\": \"Who is older, <ENTITY_Q1> or <ENTITY_Q2>?\",\n            \"requires_retrieval\": \"true\"\n        },\n        {\n            \"question\": \"Who is older, <ENTITY_Q1> or <ENTITY_Q2>?\",\n            \"requires_retrieval\": \"false\"\n        }\n    ]\n}\n\n\nIMPORTANT:\n    AVOID over-decomposition like this:\n    DON'\''T break \"Who is John Doe?\" into:\n    1. Who is John Doe? → \"English\"\n    2. When was <ENTITY_Q1> born? → \"When was English born?\"\n\n    DO ask directly: \"When was John Doe born?\"\n\nNow decompose this question:\nInput: \"When did the Lothair II'\''s mother die?\"\nOutput:"
      }
    ],
    "max_tokens": 512,
    "temperature": 0
  }' | jq
